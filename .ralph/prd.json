{
  "project": "Ralph CLI - Production Ready Release",
  "tasks": [
    {
      "title": "Add retry logic and error recovery for agent failures",
      "description": "Implement robust retry mechanism when agent processes fail or exit unexpectedly. This is critical for overnight runs where transient failures should not stop the entire workflow.",
      "steps": [
        "Add maxRetries and retryDelayMs to RalphConfig type",
        "Implement exponential backoff retry logic in useAgent hook",
        "Add error categorization to determine retryable vs fatal errors",
        "Update RunApp to handle retry states and display retry count",
        "Add configuration options in SetupWizard for retry settings"
      ],
      "done": true
    },
    {
      "title": "Implement session persistence and resume capability",
      "description": "Allow Ralph to save session state and resume after crashes, system restarts, or intentional pauses. Essential for overnight runs that may be interrupted.",
      "steps": [
        "Create session.json schema in .ralph directory with iteration count, start time, current task",
        "Implement saveSession and loadSession functions in lib/session.ts",
        "Add auto-save on each iteration completion",
        "Add resume command to CLI that reads session state",
        "Update RunApp to check for existing session on startup and prompt for resume"
      ],
      "done": true
    },
    {
      "title": "Add comprehensive logging system",
      "description": "Implement file-based logging for debugging and audit trail of long-running sessions. Logs should persist across runs and include timestamps.",
      "steps": [
        "Create lib/logger.ts with log levels (debug, info, warn, error)",
        "Implement log rotation to prevent unbounded file growth",
        "Log all agent executions, outputs, and exit codes",
        "Log iteration starts, completions, and failures",
        "Add log file path configuration option"
      ],
      "done": true
    },
    {
      "title": "Implement agent timeout and watchdog functionality",
      "description": "Add configurable timeouts for agent execution and a watchdog to detect stuck agents. Prevents infinite hangs during overnight runs.",
      "steps": [
        "Add agentTimeoutMs to RalphConfig with sensible default (30 minutes)",
        "Implement timeout wrapper around agent process in useAgent",
        "Add heartbeat detection based on stdout activity",
        "Add stuckThresholdMs config for no-output detection",
        "Kill and retry agent if timeout or stuck threshold exceeded"
      ],
      "done": true
    },
    {
      "title": "Add notification system for completion and failures",
      "description": "Implement optional notifications via system notifications, webhooks, or file markers so users can be alerted when overnight runs complete or fail.",
      "steps": [
        "Add notifications config section to RalphConfig",
        "Implement macOS system notification using osascript",
        "Add optional webhook URL support for HTTP POST notifications",
        "Create completion marker file option for script integration",
        "Send notifications on: all complete, max iterations, fatal error"
      ],
      "done": true
    },
    {
      "title": "Implement background/daemon mode",
      "description": "Allow Ralph to run detached from the terminal so it survives terminal closes and can run truly unattended overnight.",
      "steps": [
        "Add --background or -b flag to run command",
        "Implement process daemonization using nohup/disown pattern",
        "Write PID to .ralph/ralph.pid for process tracking",
        "Redirect output to log file in background mode",
        "Add 'ralph status' command to check background process"
      ],
      "done": true
    },
    {
      "title": "Add 'ralph status' command",
      "description": "Create a status command that shows current session state, progress, and running process info without interrupting an active run.",
      "steps": [
        "Add status command to CLI argument parser",
        "Read session.json and PID file to gather state",
        "Display: current task, iteration count, elapsed time, process status",
        "Show recent log entries if log file exists",
        "Handle case where no session is active gracefully"
      ],
      "done": true
    },
    {
      "title": "Add 'ralph stop' command for graceful shutdown",
      "description": "Implement a stop command that gracefully terminates a running Ralph session, saving state for potential resume.",
      "steps": [
        "Add stop command to CLI argument parser",
        "Read PID from .ralph/ralph.pid",
        "Send SIGTERM to process for graceful shutdown",
        "Update session.json with stopped state",
        "Add timeout and SIGKILL fallback if process doesn't exit"
      ],
      "done": true
    },
    {
      "title": "Add 'ralph list' command to display PRD tasks",
      "description": "Create a command to view all tasks and their completion status without starting a run. Useful for checking progress of overnight runs.",
      "steps": [
        "Add list command to CLI argument parser",
        "Load and parse PRD file",
        "Display tasks with status indicators (done/pending/in-progress)",
        "Show completion percentage and task count summary",
        "Support --json flag for machine-readable output"
      ],
      "done": true
    },
    {
      "title": "Implement progress file improvements",
      "description": "Enhance progress.txt with structured data including timestamps, iteration history, and error logs for better tracking of long runs.",
      "steps": [
        "Add timestamp to each progress entry",
        "Include iteration number with each update",
        "Log errors and retries in progress file",
        "Add session summary section at top of file",
        "Implement progress file rotation to prevent unbounded growth"
      ],
      "done": true
    },
    {
      "title": "Add memory and resource management",
      "description": "Implement safeguards against memory leaks and resource exhaustion during very long running sessions.",
      "steps": [
        "Clear agent output buffer after each iteration",
        "Implement periodic garbage collection hints",
        "Add memory usage monitoring and warnings",
        "Limit stored output history to configurable amount",
        "Clean up temporary files between iterations"
      ],
      "done": true
    },
    {
      "title": "Implement task dependency and ordering",
      "description": "Add support for task dependencies so tasks can specify prerequisites. Prevents out-of-order execution in complex PRDs.",
      "steps": [
        "Add optional 'dependsOn' field to PrdTask type",
        "Implement dependency resolution in getNextTask",
        "Validate no circular dependencies on PRD load",
        "Update init wizard to support dependency specification",
        "Display dependency tree in task list view"
      ],
      "done": true
    },
    {
      "title": "Add task priority and manual task selection",
      "description": "Allow tasks to have priority levels and let users manually select which task to work on next.",
      "steps": [
        "Add optional 'priority' field to PrdTask type (high/medium/low)",
        "Sort pending tasks by priority in getNextTask",
        "Add /next command to manually advance to specific task",
        "Update task list to show priority indicators",
        "Add --task flag to run command for single task execution"
      ],
      "done": true
    },
    {
      "title": "Implement configuration validation and defaults",
      "description": "Add robust configuration validation with clear error messages and sensible defaults for all settings.",
      "steps": [
        "Create config schema with validation rules",
        "Implement validateConfig function in lib/config.ts",
        "Add default values for all optional config fields",
        "Show clear error messages for invalid config",
        "Add 'ralph config' command to view current configuration"
      ],
      "done": true
    },
    {
      "title": "Add Linux support to update system",
      "description": "Extend the self-update system to support Linux platforms, not just macOS.",
      "steps": [
        "Update getOperatingSystem to support linux platform",
        "Add linux binaries to build configuration",
        "Update GitHub Actions workflow to build linux binaries",
        "Test update flow on Linux environments",
        "Update documentation with Linux support"
      ],
      "done": false
    },
    {
      "title": "Implement signal handling for graceful shutdown",
      "description": "Handle SIGTERM and SIGINT signals properly to ensure clean shutdown and state preservation when process is killed.",
      "steps": [
        "Add signal handlers for SIGTERM, SIGINT, SIGHUP",
        "Save session state on signal receipt",
        "Gracefully terminate running agent process",
        "Clean up PID file on exit",
        "Log shutdown reason to log file"
      ],
      "done": true
    },
    {
      "title": "Add dry-run mode for testing",
      "description": "Implement a dry-run mode that simulates agent execution without actually running agents. Useful for testing PRDs and configuration.",
      "steps": [
        "Add --dry-run flag to run command",
        "Mock agent execution with configurable delay",
        "Log what would be executed without making changes",
        "Validate PRD and config in dry-run mode",
        "Display simulated iteration flow"
      ],
      "done": true
    },
    {
      "title": "Implement iteration statistics and reporting",
      "description": "Track and display statistics about the run including time per task, success rates, and total elapsed time.",
      "steps": [
        "Create stats tracking structure in session",
        "Record start/end time for each iteration",
        "Track success/failure counts",
        "Calculate average iteration duration",
        "Display summary report on completion"
      ],
      "done": false
    },
    {
      "title": "Add max runtime limit configuration",
      "description": "Allow users to set a maximum total runtime after which Ralph will stop gracefully. Useful for time-boxed overnight runs.",
      "steps": [
        "Add maxRuntimeMs to RalphConfig",
        "Implement runtime tracking in useIteration",
        "Check runtime limit before starting new iteration",
        "Add --max-runtime CLI flag",
        "Display time remaining in status bar when limit set"
      ],
      "done": false
    },
    {
      "title": "Improve error messages and user feedback",
      "description": "Enhance error handling throughout the application with clear, actionable error messages.",
      "steps": [
        "Audit all error paths and improve messages",
        "Add suggestions for common errors",
        "Implement error codes for programmatic handling",
        "Add --verbose flag for detailed error output",
        "Include relevant context in error messages"
      ],
      "done": false
    },
    {
      "title": "Add comprehensive test suite",
      "description": "Implement unit and integration tests to ensure reliability for production use.",
      "steps": [
        "Set up bun test framework",
        "Add unit tests for lib functions (config, prd, prompt, update)",
        "Add tests for hooks (useAgent, useIteration)",
        "Create integration tests for CLI commands",
        "Add test coverage reporting"
      ],
      "done": false
    },
    {
      "title": "Create troubleshooting documentation",
      "description": "Document common issues and their solutions for production deployments.",
      "steps": [
        "Document common error scenarios and fixes",
        "Add FAQ section to README",
        "Document configuration options with examples",
        "Create example PRDs for different project types",
        "Add performance tuning recommendations"
      ],
      "done": false
    },
    {
      "title": "Fix UI offset caused by agent output stream on iteration completion",
      "description": "When a Ralph iteration completes, the last agent output stream causes the entire UI to become offset/misaligned. This visual bug needs to be fixed to maintain consistent UI layout.",
      "steps": [
        "Investigate AgentOutput component rendering behavior on iteration completion",
        "Identify the cause of UI offset when agent output stream ends",
        "Clear or reset agent output buffer properly between iterations",
        "Ensure UI layout remains stable after iteration completion",
        "Test fix across multiple consecutive iterations"
      ],
      "done": false
    },
    {
      "title": "Refactor: Centralize path constants",
      "description": "Consolidate all file path constants into a single source of truth in src/lib/paths.ts. Currently paths are scattered across multiple files: PROGRESS_FILE_PATH in progress.ts, SESSION_FILE_PATH in session.ts, INSTRUCTIONS_FILE_PATH/PRD_JSON_PATH/PRD_YAML_PATH in prd.ts, and GLOBAL_CONFIG_PATH/PROJECT_CONFIG_PATH in config.ts. This creates maintenance burden and inconsistency.",
      "steps": [
        "Add all path constants to src/lib/paths.ts: PROGRESS_FILE_PATH, SESSION_FILE_PATH, INSTRUCTIONS_FILE_PATH, PRD_JSON_PATH, PRD_YAML_PATH, GLOBAL_CONFIG_PATH, PROJECT_CONFIG_PATH",
        "Export paths as both individual constants and a structured PATHS object for organization",
        "Update src/lib/progress.ts to import PROGRESS_FILE_PATH from paths.ts instead of defining locally",
        "Update src/lib/session.ts to import SESSION_FILE_PATH from paths.ts instead of defining locally",
        "Update src/lib/prd.ts to import INSTRUCTIONS_FILE_PATH, PRD_JSON_PATH, PRD_YAML_PATH from paths.ts and remove local definitions",
        "Update src/lib/config.ts to import GLOBAL_CONFIG_PATH, PROJECT_CONFIG_PATH from paths.ts and remove local definitions",
        "Remove the re-export of ensureRalphDirExists and RALPH_DIR from prd.ts (line 13) - consumers should import directly from paths.ts"
      ],
      "done": false
    },
    {
      "title": "Refactor: Consolidate type exports to single canonical path",
      "description": "Establish @/types as the single canonical import path for all types. Currently types are re-exported from 6+ locations creating confusion: src/types.ts re-exports from src/types/index.ts, src/stores/appStore.ts re-exports ActiveView/AppState/ValidationWarning, src/lib/config.ts re-exports ConfigValidationError/ConfigValidationResult, src/lib/prd.ts re-exports DependencyValidationResult/LoadPrdResult, src/lib/progress.ts re-exports ProgressEntry/ProgressEntryType/SessionSummary. 24 files import from @/types.",
      "steps": [
        "Remove type re-exports from src/lib/config.ts line 60: 'export type { ConfigValidationError, ConfigValidationResult } from \"@/types.ts\";'",
        "Remove type re-exports from src/lib/prd.ts line 12: 'export type { DependencyValidationResult, LoadPrdResult } from \"@/types.ts\";'",
        "Remove type re-exports from src/lib/progress.ts line 6: 'export type { ProgressEntry, ProgressEntryType, SessionSummary } from \"@/types.ts\";'",
        "Remove type re-exports from src/stores/appStore.ts line 45: 'export type { ActiveView, AppState, SetManualTaskResult, ValidationWarning } from \"@/types.ts\";'",
        "Search codebase for any imports that use these re-export paths (e.g., import from '@/lib/config' for types) and update to import from '@/types' directly",
        "Verify all 24 files that import from @/types still compile correctly"
      ],
      "done": false
    },
    {
      "title": "Refactor: Extract duplicated getCurrentTaskIndex utility",
      "description": "The function getCurrentTaskIndex(prd: Prd): number is duplicated identically in two files: src/stores/appStore.ts (line 102) and src/stores/orchestrator.ts (line 33). Both implementations are: 'return prd.tasks.findIndex((task) => !task.done);'. This violates DRY and should be consolidated into src/lib/prd.ts alongside other PRD utilities.",
      "steps": [
        "Add getCurrentTaskIndex function to src/lib/prd.ts: 'export function getCurrentTaskIndex(prd: Prd): number { return prd.tasks.findIndex((task) => !task.done); }'",
        "Update src/stores/appStore.ts to import getCurrentTaskIndex from '@/lib/prd.ts' and remove the local function definition at line 102-104",
        "Update src/stores/orchestrator.ts to import getCurrentTaskIndex from '@/lib/prd.ts' and remove the local function definition at line 33-35",
        "Verify both stores still function correctly after the change"
      ],
      "done": false
    },
    {
      "title": "Refactor: Create ConfigService and PrdService to eliminate repeated disk reads",
      "description": "loadConfig() is called 27 times across 8 files and loadPrd() is called 16 times across 6 files, each time reading from disk. This causes performance overhead and potential inconsistency if files change mid-operation. Create singleton services that load once and cache, with invalidate() for when files change (e.g., after init wizard).",
      "steps": [
        "Create src/lib/services/ directory for service classes",
        "Create src/lib/services/ConfigService.ts as a singleton class with: private cachedConfig, load() that reads from disk only if cache is null, get() that returns cached config, invalidate() that clears cache, and getWithValidation() for validated access",
        "Create src/lib/services/PrdService.ts as a singleton class with: private cachedPrd, load() that reads from disk only if cache is null, get() that returns cached PRD, invalidate() that clears cache, reload() that forces a fresh read",
        "Update src/lib/config.ts to keep loadConfig() as a thin wrapper that calls ConfigService.get() for backward compatibility",
        "Update src/lib/prd.ts to keep loadPrd() as a thin wrapper that calls PrdService.get() for backward compatibility",
        "Update src/stores/appStore.ts to call ConfigService.invalidate() and PrdService.invalidate() after init wizard completes or config changes",
        "Update src/stores/orchestrator.ts callbacks (onIterationComplete, onAllComplete) to use PrdService.reload() when PRD may have changed",
        "Create src/lib/services/index.ts to export both services"
      ],
      "done": false
    },
    {
      "title": "Refactor: Encapsulate module-level mutable state in service classes",
      "description": "Module-level mutable variables exist outside Zustand stores creating hidden state that's difficult to track and test. In src/stores/agentStore.ts lines 125-128: processRef, abortedRef, retryCountRef. In src/stores/iterationStore.ts lines 42-43: delayTimeoutRef, projectCompleteRef. These should be encapsulated in proper service classes.",
      "steps": [
        "Create src/lib/services/AgentProcessManager.ts class with: private process (Subprocess | null), private aborted (boolean), private retryCount (number), methods: spawn(command, prompt), kill(), isRunning(), getRetryCount(), incrementRetry(), resetRetry(), setAborted(value), isAborted()",
        "Create src/lib/services/IterationTimer.ts class with: private delayTimeout (ReturnType<typeof setTimeout> | null), private projectComplete (boolean), methods: scheduleNext(delayMs, callback), cancel(), setProjectComplete(value), isProjectComplete()",
        "Update src/stores/agentStore.ts to use AgentProcessManager instead of module-level refs: replace processRef with agentProcessManager.process, abortedRef with agentProcessManager.isAborted(), retryCountRef with agentProcessManager.getRetryCount()",
        "Update src/stores/iterationStore.ts to use IterationTimer instead of module-level refs: replace delayTimeoutRef with iterationTimer, projectCompleteRef with iterationTimer.isProjectComplete()",
        "Export service instances from src/lib/services/index.ts",
        "Ensure cleanup methods are called appropriately on store reset/stop actions"
      ],
      "done": false
    },
    {
      "title": "Refactor: Introduce event bus to decouple stores",
      "description": "Stores directly call getState() on each other creating tight coupling. There are 35 cross-store getState() calls across 5 files: src/stores/orchestrator.ts (17), src/stores/appStore.ts (12), src/stores/agentStore.ts (4), src/components/RunApp.tsx (1), src/index.tsx (1). Stores should emit events and only the orchestrator should coordinate between them.",
      "steps": [
        "Create src/lib/events.ts with a typed EventEmitter class supporting events: 'agent:start', 'agent:complete', 'agent:error', 'agent:retry', 'iteration:start', 'iteration:complete', 'iteration:delay', 'session:start', 'session:stop', 'session:complete'",
        "Define event payload types for each event (e.g., AgentCompleteEvent with isComplete, exitCode fields)",
        "Export a singleton eventBus instance from events.ts",
        "Update src/stores/agentStore.ts: emit 'agent:complete' when agent finishes instead of directly calling useAppStore.getState().handleAgentComplete(), emit 'agent:error' on fatal errors",
        "Update src/stores/iterationStore.ts: emit 'iteration:start', 'iteration:complete', 'iteration:delay' events instead of directly calling callbacks that access other stores",
        "Update src/stores/orchestrator.ts to subscribe to all events from eventBus and coordinate between stores - this becomes the single place that calls getState() on multiple stores",
        "Remove direct useXStore.getState() calls from agentStore and iterationStore (keep only in orchestrator)",
        "Update src/stores/appStore.ts to emit events for session lifecycle instead of directly manipulating other stores"
      ],
      "done": false
    },
    {
      "title": "Refactor: Consolidate session lifecycle management in orchestrator",
      "description": "Both src/stores/appStore.ts and src/stores/orchestrator.ts handle session start/resume/stop with duplicated logging. appStore has startIterations(), resumeSession(), handleFatalError() that duplicate orchestrator's startSession(), resumeSession(), handleFatalError(). The orchestrator should own all session lifecycle; appStore should only manage UI state.",
      "steps": [
        "Move session creation logic from appStore.startIterations() to orchestrator.startSession(): createSession(), saveSession(), logger.logSessionStart(), logProgressSessionStart()",
        "Move session resume logic from appStore.resumeSession() to orchestrator.resumeSession(): updateSessionStatus(), saveSession(), logger.logSessionResume(), logProgressSessionResume()",
        "Move fatal error handling from appStore.handleFatalError() to orchestrator.handleFatalError(): logger.error(), logProgressError(), logProgressSessionStopped(), sendNotifications(), updateSessionStatus()",
        "Simplify appStore.startIterations() to: validate project, set UI state (appState, validationWarning), call orchestrator.startSession(), then iterationStore.start()",
        "Simplify appStore.resumeSession() to: validate project, set UI state, call orchestrator.resumeSession(), then iterationStore.start()",
        "Simplify appStore.handleFatalError() to: call orchestrator.handleFatalError(), set appState to 'error'",
        "Remove duplicated logging calls from appStore that are now handled by orchestrator",
        "Update appStore to only manage: appState, activeView, validationWarning, elapsedTime, pendingSession reference (not lifecycle)"
      ],
      "done": false
    },
    {
      "title": "Refactor: Split config.ts into focused modules",
      "description": "src/lib/config.ts is 553 lines handling multiple concerns: config loading/saving (loadConfig, saveConfig, loadGlobalConfig, etc.), config validation (validateConfig, validatePositiveInteger, etc.), config formatting (formatValidationErrors, getConfigSummary, formatMs, formatBytes), and constants (AGENT_COMMANDS, CONFIG_DEFAULTS). Split into single-responsibility modules.",
      "steps": [
        "Create src/lib/config/ directory for config submodules",
        "Create src/lib/config/loader.ts with: loadConfig(), saveConfig(), loadGlobalConfig(), saveGlobalConfig(), loadGlobalConfigRaw(), loadProjectConfigRaw(), loadConfigWithValidation(), getEffectiveConfig(), globalConfigExists(), getGlobalConfigPath(), getProjectConfigPath(), applyDefaults()",
        "Create src/lib/config/validator.ts with: validateConfig(), validatePositiveInteger(), validateString(), validateBoolean(), validateUrl(), validateNotificationConfig(), validateMemoryConfig(), and the ConfigValidationError/ConfigValidationResult type imports",
        "Create src/lib/config/formatter.ts with: formatValidationErrors(), getConfigSummary(), formatMs(), formatBytes()",
        "Move AGENT_COMMANDS to src/lib/defaults.ts alongside other defaults, or create src/lib/agents.ts if it grows",
        "Keep CONFIG_DEFAULTS in loader.ts as it's used by applyDefaults()",
        "Create src/lib/config/index.ts that re-exports everything from submodules for backward compatibility: export * from './loader', export * from './validator', export * from './formatter'",
        "Update src/lib/config.ts to simply re-export from src/lib/config/index.ts for backward compatibility",
        "Verify all existing imports of '@/lib/config' still work"
      ],
      "done": false
    },
    {
      "title": "Refactor: Simplify RunApp component by extracting hooks and ViewRouter",
      "description": "src/components/RunApp.tsx is 310 lines with too many responsibilities: manages 8+ view states, handles all slash commands, coordinates 3 stores, contains 7 useEffect hooks. Extract into focused hooks and a view router component.",
      "steps": [
        "Create src/hooks/useSlashCommands.ts hook that encapsulates handleSlashCommand logic: takes dependencies (startIterations, resumeSession, stopAgent, setManualNextTask, agentStop, iterationPause, setActiveView, exit), returns handleSlashCommand callback and nextTaskMessage state",
        "Create src/hooks/useAgentLifecycle.ts hook that encapsulates agent-related effects: the useEffect for starting agent when iteration is running (lines 201-205), the useEffect for handling agent complete (lines 207-211), the useEffect for handling fatal errors (lines 220-224)",
        "Create src/hooks/useSessionLifecycle.ts hook that encapsulates session-related effects: the useEffect for initial state loading (lines 162-166), the useEffect for auto-resume (lines 168-172), the useEffect for auto-start/initial-task (lines 174-199), the useEffect for elapsed time timer (lines 213-218)",
        "Create src/components/ViewRouter.tsx component that handles view switching: takes activeView, version, handlers as props, renders appropriate view component (InitWizard, SetupWizard, UpdatePrompt, HelpView, AddTaskWizard, DryRunView, NotInitializedView, ResumePromptView, or MainRunView)",
        "Create src/components/MainRunView.tsx for the main run view content (lines 269-310 of current RunApp): Header, TaskList, IterationProgress, AgentOutput, status messages, CommandInput, StatusBar",
        "Refactor RunApp.tsx to compose these pieces: use the custom hooks, render ViewRouter with MainRunView as the default view",
        "Update src/components/index.ts to export new components",
        "Update src/hooks/index.ts to export new hooks"
      ],
      "done": false
    },
    {
      "title": "Add Codex agent support",
      "description": "Add OpenAI Codex CLI as a supported coding agent in Ralph, allowing users to select Codex as their AI agent alongside Cursor and Claude Code.",
      "steps": [
        "Add 'codex' to the AgentType union type in src/types/config.types.ts",
        "Add 'codex' to the VALID_AGENTS array in src/lib/config.ts",
        "Add Codex CLI command configuration to AGENT_COMMANDS in src/lib/config.ts (e.g., ['codex', '-q', '--approval-mode', 'full-auto'])",
        "Update parseStreamJsonLine function in src/lib/agent.ts if Codex uses a different output format",
        "Add Codex option to AGENT_CHOICES array in src/components/SetupWizard.tsx",
        "Update the agent name display logic in SetupWizard.tsx completion screen to handle 'codex' type",
        "Test agent selection, configuration saving, and agent invocation with Codex"
      ],
      "done": false
    }
  ]
}