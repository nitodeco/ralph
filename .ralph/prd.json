{
	"project": "Ralph CLI",
	"tasks": [
		{
			"title": "Wire up /tasks command and view routing",
			"description": "Connect the TasksView to the application by adding the tasks command and routing. This makes the view accessible via /tasks slash command.",
			"steps": [
				"Add 'tasks' to ActiveView type in src/types/app.types.ts",
				"Add 'tasks' to SlashCommand type and VALID_COMMANDS array in src/components/CommandInput.tsx",
				"Handle 'tasks' command in src/hooks/useSlashCommands.ts to set active view",
				"Add TasksView route in src/components/ViewRouter.tsx"
			],
			"done": true
		},
		{
			"title": "Add toggle done functionality to TasksView",
			"description": "Enable users to mark tasks as done or undone directly from the TasksView using the 'd' key. This is the highest-value mutation for task management.",
			"steps": [
				"Add 'd' key handler in TasksView that calls toggleTaskDone",
				"Save the updated PRD and refresh the local state",
				"Show success message when task status changes",
				"Update the task list display to reflect the change immediately"
			],
			"done": true
		},
		{
			"title": "Add delete task functionality with confirmation",
			"description": "Allow users to delete tasks from the TasksView with a confirmation step to prevent accidental deletions.",
			"steps": [
				"Add 'confirm-delete' to TaskViewMode type",
				"Add 'x' key handler that switches to confirm-delete mode",
				"Show confirmation prompt with task title",
				"Handle Enter to confirm deletion, Escape to cancel",
				"Adjust selected index after deletion to stay in bounds"
			],
			"done": true
		},
		{
			"title": "Gracefully handle non-git repositories",
			"description": "Ralph currently instructs the AI agent to commit changes after each task, but doesn't verify the project is a git repository. This causes issues when running ralph in directories without git initialized. Add detection and adapt behavior accordingly.",
			"steps": [
				"Add isGitRepository() utility function in src/lib/paths.ts that checks for .git directory existence",
				"Add git repository check to validateProject() in src/stores/appStore.ts, setting a warning flag (not blocking)",
				"Modify buildPrompt() in src/lib/prompt.ts to conditionally include commit instructions based on git availability",
				"Update dry-run validation in src/hooks/useDryRun.ts to warn when not in a git repository",
				"Add tests for the new isGitRepository() function"
			],
			"done": true
		},
		{
			"title": "Create project registry types and resolution logic",
			"description": "Ralph currently stores project data in a local .ralph directory within each repository. We are migrating to store all project data in a global ~/.ralph/projects/ directory, with each project identified by either its git remote URL (preferred) or a hash of its filesystem path (fallback). This task creates the foundational types and pure functions for this identification system. The types define how projects are identified (ProjectIdType: 'git' | 'path' | 'custom'), how metadata is stored (ProjectMetadata with displayName, lastAccessedAt, lastKnownPath), and how the registry index is structured (ProjectRegistry with a projects map and pathCache for fast lookups). The resolution functions handle normalizing git remote URLs (stripping protocols, .git suffix), hashing filesystem paths, and sanitizing strings for use as folder names.",
			"steps": [
				"Create src/lib/services/project-registry/types.ts with ProjectIdType ('git' | 'path' | 'custom'), ProjectIdentifier (type, value, folderName), ProjectMetadata (identifier, displayName, createdAt, lastAccessedAt, lastKnownPath, gitRemote?), and ProjectRegistry (version, projects map, pathCache map) interfaces",
				"Create src/lib/services/project-registry/resolution.ts with pure functions: normalizeGitRemote(url) strips protocol and .git suffix, hashPath(absolutePath) creates short deterministic hash, sanitizeFolderName(name) replaces invalid chars with dashes, buildFolderName(identifier) creates folder name like 'git--github.com-user-repo'",
				"Create src/lib/services/project-registry/git.ts with getGitRemoteUrl(cwd) function that runs 'git remote get-url origin' and returns null if not a git repo or no remote",
				"Add unit tests for all resolution functions in src/__tests__/lib/project-registry/resolution.test.ts covering edge cases like SSH vs HTTPS URLs, paths with special characters"
			],
			"done": true
		},
		{
			"title": "Implement ProjectRegistryService",
			"description": "Build the service that manages the global project registry at ~/.ralph/registry.json and project data folders at ~/.ralph/projects/<folder-name>/. The service resolves which project the current working directory belongs to using a priority system: first check the pathCache for instant lookup, then try git remote detection, then fall back to path-based hashing. If no project is found, it returns null (not initialized). The service also handles registering new projects (creating their folder and adding to registry), and provides utilities for listing all projects and cleaning up orphaned entries. Follow the service pattern established by other services in src/lib/services/ (e.g., session/implementation.ts, config/implementation.ts).",
			"steps": [
				"Create src/lib/services/project-registry/implementation.ts with createProjectRegistryService() factory function",
				"Implement loadRegistry() that reads ~/.ralph/registry.json or returns empty registry {version:1, projects:{}, pathCache:{}}, and saveRegistry() that writes it",
				"Implement ensureProjectsDir() that creates ~/.ralph/projects/ if it doesn't exist",
				"Implement resolveCurrentProject() that checks pathCache first, then tries git remote detection, then path hash, returning ProjectIdentifier or null",
				"Implement registerProject(cwd, options?) that determines identifier, creates project folder, updates registry and pathCache, returns ProjectIdentifier",
				"Implement getProjectDir(identifier?) and getProjectFilePath(relativePath, identifier?) that return absolute paths to project storage",
				"Implement listProjects(), getProjectMetadata(identifier), updateLastAccessed(identifier), isProjectInitialized(cwd?)",
				"Add unit tests in src/__tests__/lib/project-registry/implementation.test.ts using temp directories",
				"Create src/lib/services/project-registry/index.ts that exports all public types and the factory function"
			],
			"done": true
		},
		{
			"title": "Integrate ProjectRegistryService into service container",
			"description": "Ralph uses a service container pattern (src/lib/services/container.ts) to manage singleton services. The container is initialized at startup via bootstrapServices() in bootstrap.ts. Add the ProjectRegistryService to this container. It must be created first because other services will depend on it for resolving file paths. Also add a mock implementation for tests following the pattern in bootstrapTestServices().",
			"steps": [
				"Add 'projectRegistry: ProjectRegistryService' to ServiceContainer interface in src/lib/services/container.ts",
				"Add getProjectRegistryService() accessor function following the pattern of getConfigService(), getSessionService(), etc.",
				"Update bootstrapServices() in src/lib/services/bootstrap.ts to create projectRegistry first via createProjectRegistryService() and pass it to initializeServices()",
				"Add createMockProjectRegistryService() in bootstrap.ts that returns a mock with sensible defaults (resolveCurrentProject returns a test identifier, getProjectDir returns a temp path)",
				"Update bootstrapTestServices() to include the mock projectRegistry",
				"Export ProjectRegistryService type and getProjectRegistryService from src/lib/services/index.ts"
			],
			"done": false
		},
		{
			"title": "Convert path constants to registry-based functions",
			"description": "Currently src/lib/paths.ts exports constants like SESSION_FILE_PATH = '.ralph/session.json' that point to the local .ralph directory. Convert these to functions that use the ProjectRegistryService to get the correct path in ~/.ralph/projects/<project-folder>/. Keep global paths (GLOBAL_RALPH_DIR, GLOBAL_CONFIG_PATH) as constants since they don't change per-project. The key insight is that after this change, all existing code that imports these paths will automatically use the new global storage location without any changes to those files.",
			"steps": [
				"Add new constants to paths.ts: REGISTRY_PATH = join(GLOBAL_RALPH_DIR, 'registry.json'), PROJECTS_DIR = join(GLOBAL_RALPH_DIR, 'projects')",
				"Convert SESSION_FILE_PATH to getSessionFilePath() function that calls getProjectRegistryService().getProjectFilePath('session.json')",
				"Convert PRD_JSON_PATH to getPrdJsonPath(), PROGRESS_FILE_PATH to getProgressFilePath(), INSTRUCTIONS_FILE_PATH to getInstructionsFilePath()",
				"Convert PROJECT_CONFIG_PATH to getProjectConfigPath(), GUARDRAILS_FILE_PATH to getGuardrailsFilePath(), FAILURE_HISTORY_FILE_PATH to getFailureHistoryFilePath()",
				"Convert SESSION_MEMORY_FILE_PATH to getSessionMemoryFilePath(), LOGS_DIR to getLogsDir(), and add getArchiveDir()",
				"Update ensureRalphDirExists() to call getProjectRegistryService().getProjectDir() and create that directory instead of local .ralph",
				"Keep the old constants temporarily but have them throw an error with migration instructions if accessed (or remove if confident all usages are updated)"
			],
			"done": false
		},
		{
			"title": "Update all services to use new path functions",
			"description": "After converting path constants to functions in paths.ts, update all files that import and use these paths. Most services in src/lib/services/ import paths like SESSION_FILE_PATH and use them directly. Change these imports to use the new function versions. Also update any other files outside of services that reference these paths (components, stores, utilities). This is mechanical work but must be thorough to avoid runtime errors.",
			"steps": [
				"Update src/lib/services/session/implementation.ts: change SESSION_FILE_PATH import to getSessionFilePath and call it as a function",
				"Update src/lib/services/prd/implementation.ts: change PRD_JSON_PATH import to getPrdJsonPath function",
				"Update src/lib/services/config/implementation.ts: change PROJECT_CONFIG_PATH import to getProjectConfigPath function",
				"Update src/lib/services/guardrails/implementation.ts: change GUARDRAILS_FILE_PATH import to getGuardrailsFilePath function",
				"Update src/lib/services/session-memory/implementation.ts: change SESSION_MEMORY_FILE_PATH import to getSessionMemoryFilePath function",
				"Update src/lib/progress.ts, src/lib/archive.ts, src/lib/iteration-logs.ts, src/lib/logger.ts to use new path functions",
				"Search codebase for any remaining imports of old path constants and update them",
				"Run 'bun test' to verify all existing tests still pass"
			],
			"done": false
		},
		{
			"title": "Update init flow for global storage",
			"description": "The InitWizard component (src/components/InitWizard.tsx) currently creates a local .ralph directory with prd.json, progress.txt, and config.json. Update it to instead register the project in the global registry and store files in ~/.ralph/projects/<project-folder>/. Also update the project validation logic in appStore.ts that checks whether a project is initialized—it should now check the registry instead of looking for a local .ralph directory.",
			"steps": [
				"Update InitWizard.tsx: after generating PRD, call getProjectRegistryService().registerProject(process.cwd(), {displayName: prd.project}) before saving files",
				"Remove ensureRalphDirExists() call that creates local .ralph directory (the registry service handles creating the project folder)",
				"Remove code that creates .ralph/.gitignore file since we no longer use local storage",
				"Update success message to show the global storage path instead of '.ralph/prd.json'",
				"Update validateProject() in src/stores/appStore.ts to use getProjectRegistryService().isProjectInitialized() instead of checking for local .ralph directory",
				"Update findPrdFile() in src/lib/prd.ts to use getPrdJsonPath() from registry instead of looking for local file",
				"Test the full init flow: run 'ralph init' in a new directory and verify files are created in ~/.ralph/projects/"
			],
			"done": false
		},
		{
			"title": "Add migration command and auto-migration prompt",
			"description": "Existing Ralph users have project data in local .ralph directories. Provide a migration path: a 'ralph migrate' CLI command that moves local .ralph contents to the global location, and an automatic prompt shown when Ralph detects a local .ralph directory that isn't in the registry. The migration should copy all files (prd.json, session.json, progress.txt, logs/, archive/, etc.) to the new location, update the registry, and optionally remove the local directory.",
			"steps": [
				"Create src/lib/services/project-registry/migration.ts with migrateLocalRalphDir(cwd) function that: detects local .ralph, registers project in registry, copies all files to new location, returns MigrationResult",
				"Add 'migrate' command in src/cli/commands/migrate.ts that calls migrateLocalRalphDir and reports results",
				"Register the migrate command in src/cli/commands/index.ts",
				"Create src/components/views/MigrationPromptView.tsx that shows: 'Ralph detected a local .ralph directory. Migrate to global storage? [Y/N]'",
				"Add 'migration_prompt' to ActiveView type and handle it in ViewRouter.tsx",
				"Update loadInitialState() in appStore.ts: if local .ralph exists but isProjectInitialized() returns false, set activeView to 'migration_prompt'",
				"After successful migration, show option to delete local .ralph directory or keep it as backup"
			],
			"done": false
		},
		{
			"title": "Add project management commands",
			"description": "Add CLI commands for users to view and manage all their registered Ralph projects across different repositories. 'ralph projects' lists all projects with their names, paths, and last accessed dates. 'ralph projects --current' shows details about the current directory's project. 'ralph projects --prune' removes registry entries for projects whose paths no longer exist on disk. This gives users visibility into and control over their global project storage.",
			"steps": [
				"Create src/cli/commands/projects.ts with handler that parses --current, --prune, --json flags",
				"Implement list functionality: call getProjectRegistryService().listProjects(), format as table with columns: Name, Path, Last Accessed",
				"Implement --current flag: call resolveCurrentProject(), show full metadata or 'Not a Ralph project' if null",
				"Implement --prune flag: iterate projects, check if lastKnownPath exists on disk, remove orphaned entries, report count removed",
				"Implement --json flag: output results as JSON for scripting",
				"Create src/components/views/ProjectsView.tsx for interactive project list with keyboard navigation (following MemoryView pattern)",
				"Add 'projects' to CLI commands in src/cli/commands/index.ts",
				"Add '/projects' slash command that opens ProjectsView"
			],
			"done": false
		},
		{
			"title": "Format long pasted text as collapsible placeholders in input fields",
			"description": "When users paste long text (multiline or exceeding a character threshold) into TextInput fields, display it as a compact placeholder like '[Pasted text #1]' instead of showing the full content. This follows the pattern used by Claude Code and other CLI coding agents, keeping the input readable while preserving the full pasted content for submission. Multiple pastes in the same input should be numbered sequentially.",
			"steps": [
				"Add PastedTextSegment type (id: number, content: string, placeholder: string) and update TextInputProps in src/components/common/TextInput.tsx to support paste tracking with onPaste callback and pastedSegments state",
				"Create isPasteLongEnough(text: string) utility that returns true if text contains newlines or exceeds 80 characters",
				"Modify useInput handler in TextInput to detect pastes (input.length > 1), check if long enough, and either insert placeholder or raw text",
				"Update TextInput rendering to display placeholders inline with regular text, showing '[Pasted text #N]' in a distinct style (dimmed or colored)",
				"Add expandPastedSegments(displayValue: string, segments: PastedTextSegment[]) utility that replaces placeholders with actual content for submission",
				"Update CommandInput.tsx to track pasted segments state and expand placeholders before calling onSubmit",
				"Update InitWizard.tsx and AddTaskWizard.tsx TextInput usages to support paste placeholders where appropriate (description fields)",
				"Add unit tests for isPasteLongEnough and expandPastedSegments utilities"
			],
			"done": false
		},
		{
			"title": "Add /plan command for AI-powered PRD generation from spec",
			"description": "Enable users to generate a structured PRD with tasks by providing a free-form specification via the /plan slash command. The user types or pastes their spec (any format—bullet points, prose, file references), and the configured coding agent analyzes it along with existing PRD tasks to produce a well-scoped sprint. The agent intelligently merges with existing tasks: keeping tasks that align with the spec, removing contradictory ones, and modifying tasks that need updates. After generation, the user reviews and confirms the proposed tasks before they are saved. Note: This feature depends on the global project storage migration (tasks 7-12) since the PRD must be written to ~/.ralph/projects/<project>/ rather than the local .ralph directory. It also benefits from the /tasks view (tasks 2-5) for reviewing generated tasks.",
			"steps": [
				"Add 'plan' to SlashCommand type and VALID_COMMANDS array in src/components/CommandInput.tsx",
				"Add 'plan' to ActiveView type in src/types/app.types.ts",
				"Handle 'plan' command in src/hooks/useSlashCommands.ts to set active view to 'plan'",
				"Create src/components/views/PlanInputView.tsx with a multi-line TextInput for spec entry, instructions text explaining the feature, and Submit/Cancel buttons with keyboard shortcuts (Enter to submit, Escape to cancel)",
				"Create src/lib/prompts/plan-prompt.ts with buildPlanPrompt(spec: string, existingPrd: Prd) function that constructs the agent prompt including: the user's spec, existing tasks for context, instructions to output valid JSON matching the Prd task schema, and guidance on merging/replacing/keeping existing tasks",
				"Create src/components/views/PlanGeneratingView.tsx that shows a Spinner with status message while the agent runs, using AgentProcessManager to spawn the coding agent with the plan prompt",
				"Create src/lib/plan-parser.ts with parsePlanOutput(agentOutput: string): PrdTask[] function that extracts the JSON task array from agent output, validates against task schema, and throws descriptive errors on parse failure",
				"Create src/components/views/PlanReviewView.tsx that displays proposed tasks in a scrollable list (title, description preview, step count), with keyboard navigation, Accept (Enter) and Reject (Escape) actions, and diff indicators showing which tasks are new/modified/removed compared to existing PRD",
				"Add plan view routing in src/components/ViewRouter.tsx to render PlanInputView, PlanGeneratingView, or PlanReviewView based on plan phase state",
				"Add planPhase state ('input' | 'generating' | 'review') and generatedTasks state to appStore.ts to track the plan workflow",
				"Implement the accept flow: on confirmation, call getPrdJsonPath() to get the global storage path, merge project name with generated tasks, write to prd.json, show success message, and return to main view",
				"Add error handling: show error message if agent fails or output parsing fails, with option to retry or cancel",
				"Export all new views from src/components/views/index.ts"
			],
			"done": false
		}
	]
}
