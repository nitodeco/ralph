=== Task Completed ===
Task: Refactor: Centralize path constants
Date: 2026-01-20

Changes made:
- Added all path constants to src/lib/paths.ts: PROGRESS_FILE_PATH, SESSION_FILE_PATH, INSTRUCTIONS_FILE_PATH, PRD_JSON_PATH, PRD_YAML_PATH, GLOBAL_CONFIG_PATH, PROJECT_CONFIG_PATH
- Created structured PATHS object for organized access to all paths
- Updated src/lib/progress.ts to import and re-export PROGRESS_FILE_PATH from paths.ts
- Updated src/lib/session.ts to import and re-export SESSION_FILE_PATH from paths.ts
- Updated src/lib/prd.ts to import path constants from paths.ts, removed local definitions and re-exports of ensureRalphDirExists/RALPH_DIR
- Updated src/lib/config.ts to import GLOBAL_CONFIG_PATH and PROJECT_CONFIG_PATH from paths.ts
- Updated consumers (InitWizard.tsx, daemon.ts, memory.ts) to import directly from paths.ts instead of prd.ts

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Refactor: Consolidate type exports to single canonical path
Date: 2026-01-20

Changes made:
- Removed type re-exports from src/lib/config.ts (ConfigValidationError, ConfigValidationResult)
- Removed type re-exports from src/lib/prd.ts (LoadPrdResult)
- Removed type re-exports from src/stores/appStore.ts (ActiveView, AppState, SetManualTaskResult, ValidationWarning)
- Updated src/stores/index.ts to re-export types from @/types instead of appStore.ts

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Refactor: Extract duplicated getCurrentTaskIndex utility
Date: 2026-01-20

Changes made:
- Added getCurrentTaskIndex function to src/lib/prd.ts
- Updated src/stores/appStore.ts to import getCurrentTaskIndex from @/lib/prd.ts and removed local function definition
- Updated src/stores/orchestrator.ts to import getCurrentTaskIndex from @/lib/prd.ts and removed local function definition

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Refactor: Create ConfigService and PrdService to eliminate repeated disk reads
Date: 2026-01-20

Changes made:
- Created src/lib/services/ directory for service classes
- Created src/lib/services/ConfigService.ts as a singleton class with caching for config reads
- Created src/lib/services/PrdService.ts as a singleton class with caching for PRD reads
- Created src/lib/services/index.ts to export both services
- Updated src/lib/config.ts to use ConfigService as thin wrapper for backward compatibility
- Updated src/lib/prd.ts to use PrdService as thin wrapper for backward compatibility
- Added invalidateConfigCache() and invalidatePrdCache() functions for cache invalidation
- Added reloadPrd() function for forced fresh reads
- Updated src/stores/appStore.ts to invalidate caches in revalidateAndGoIdle()
- Updated src/stores/orchestrator.ts to use reloadPrd() in callbacks where PRD may have changed
- Updated test files to invalidate caches in beforeEach hooks

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Refactor: Encapsulate module-level mutable state in service classes
Date: 2026-01-20

Changes made:
- Created src/lib/services/AgentProcessManager.ts as a singleton class to manage: process (Subprocess | null), aborted state, retry count, and force kill timeout
- Created src/lib/services/IterationTimer.ts as a singleton class to manage: delay timeout and project complete state
- Updated src/stores/agentStore.ts to use AgentProcessManager instead of module-level refs (processRef, abortedRef, retryCountRef, forceKillTimeoutRef)
- Updated src/stores/iterationStore.ts to use IterationTimer instead of module-level refs (delayTimeoutRef, projectCompleteRef)
- Exported both services from src/lib/services/index.ts

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Refactor: Introduce event bus to decouple stores
Date: 2026-01-20

Changes made:
- Created src/lib/events.ts with typed EventEmitter class supporting events: agent:start, agent:complete, agent:error, agent:retry, iteration:start, iteration:complete, iteration:delay, session:start, session:resume, session:stop, session:complete
- Defined event payload types for each event (AgentCompleteEvent, AgentErrorEvent, IterationStartEvent, etc.)
- Exported singleton eventBus instance from events.ts
- Updated src/stores/agentStore.ts to emit agent events (agent:start, agent:complete, agent:error, agent:retry) instead of directly calling useAppStore.getState()
- Updated agentStore.start() to accept optional specificTask parameter instead of fetching from appStore
- Updated src/stores/iterationStore.ts to emit iteration events (iteration:start, iteration:complete, iteration:delay)
- Updated src/stores/orchestrator.ts to subscribe to event bus for agent:complete and agent:error events
- Orchestrator now coordinates agent start by calling agentStore.start(specificTask) in onIterationStart callback
- Updated src/stores/appStore.ts to emit session lifecycle events (session:start, session:resume, session:stop)
- Removed direct useAppStore.getState() call from agentStore (now only orchestrator coordinates between stores)
- Removed agent start useEffect from RunApp.tsx (orchestrator now handles agent lifecycle)

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Refactor: Consolidate session lifecycle management in orchestrator
Date: 2026-01-20

Changes made:
- Moved session creation logic from appStore.startIterations() to orchestrator.startSession()
- Moved session resume logic from appStore.resumeSession() to orchestrator.resumeSession()
- Moved fatal error handling from appStore.handleFatalError() to orchestrator.handleFatalError()
- Simplified appStore methods to only manage UI state and delegate session lifecycle to orchestrator
- Added StartSessionResult and ResumeSessionResult types to orchestrator for better type safety
- Orchestrator now emits session events (session:start, session:resume, session:stop) centrally
- Removed unused getCurrentTaskIndex import from appStore

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Refactor: Split config.ts into focused modules
Date: 2026-01-20

Changes made:
- Created src/lib/config/ directory for config submodules
- Created src/lib/config/constants.ts with: CONFIG_DEFAULTS, DEFAULT_CONFIG, VALID_AGENTS, VALID_PRD_FORMATS, AGENT_COMMANDS, and default constant exports
- Created src/lib/config/loader.ts with: applyDefaults(), loadConfig(), saveConfig(), loadGlobalConfig(), saveGlobalConfig(), loadGlobalConfigRaw(), loadProjectConfigRaw(), loadConfigWithValidation(), getEffectiveConfig(), globalConfigExists(), getGlobalConfigPath(), getProjectConfigPath(), getAgentCommand(), invalidateConfigCache()
- Created src/lib/config/validator.ts with: validateConfig(), validatePositiveInteger(), validateString(), validateBoolean(), validateUrl(), validateNotificationConfig(), validateMemoryConfig()
- Created src/lib/config/formatter.ts with: formatValidationErrors(), getConfigSummary(), formatMs(), formatBytes()
- Created src/lib/config/index.ts to re-export everything from submodules for backward compatibility
- Updated src/lib/config.ts to re-export from src/lib/config/index.ts for backward compatibility
- All existing imports of '@/lib/config' continue to work unchanged

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Refactor: Simplify RunApp component by extracting hooks and ViewRouter
Date: 2026-01-20

Changes made:
- Created src/hooks/useSlashCommands.ts hook that encapsulates slash command handling logic with nextTaskMessage state
- Created src/hooks/useSessionLifecycle.ts hook that encapsulates session-related effects (initial state loading, auto-resume, auto-start, elapsed time timer, fatal error handling, orchestrator cleanup)
- Created src/components/ViewRouter.tsx component that handles view switching for all view types (init, setup, update, help, add, status, archive, dry run, not initialized, resume prompt)
- Created src/components/MainRunView.tsx component for the main run view content (Header, TaskList, IterationProgress, AgentOutput, status messages, CommandInput, StatusBar)
- Refactored RunApp.tsx from 310+ lines to ~150 lines by composing the extracted hooks and components
- Updated src/hooks/index.ts to export useSlashCommands and useSessionLifecycle
- Updated src/components/index.ts to export MainRunView and ViewRouter
- Used canonical ActiveView type from @/types instead of defining a duplicate type

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Add Codex agent support
Date: 2026-01-20

Changes made:
- Added 'codex' to the AgentType union type in src/types/config.types.ts
- Added 'codex' to VALID_AGENTS array in src/lib/config/constants.ts
- Added Codex CLI command configuration to AGENT_COMMANDS: ['codex', '-q', '--approval-mode', 'full-auto']
- Added Codex option to AGENT_CHOICES in src/components/SetupWizard.tsx
- Updated agent name display logic in SetupWizard.tsx completion screen to use a Record<AgentType, string> map
- Updated AGENT_DISPLAY_NAMES in src/components/Header.tsx to include 'codex'
- Fixed IterationLogAgent type in src/types/session.types.ts to use AgentType instead of hardcoded union

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Implement dynamic prompt guardrail system
Date: 2026-01-20

Changes made:
- Created PromptGuardrail interface in src/types/config.types.ts with fields: id, instruction, trigger, category, enabled, addedAt, addedAfterFailure
- Added GUARDRAILS_FILE_PATH constant to src/lib/paths.ts pointing to .ralph/guardrails.json
- Created src/lib/guardrails.ts with functions: loadGuardrails(), saveGuardrails(), addGuardrail(), removeGuardrail(), toggleGuardrail(), getActiveGuardrails(), formatGuardrailsForPrompt()
- Added DEFAULT_GUARDRAILS to src/lib/defaults.ts with essential guardrails: verify before commit, read existing patterns, fix build before proceeding
- Updated buildPrompt() in src/lib/prompt.ts to inject active guardrails under a "## Guardrails" section
- Added 'ralph guardrails' CLI command with list, add, remove, and toggle subcommands
- Created src/cli/commands/guardrails.ts with printGuardrails(), handleGuardrailsAdd(), handleGuardrailsRemove(), handleGuardrailsToggle()
- Added GuardrailsSubcommand type to src/types/cli.types.ts
- Updated parser.ts to handle guardrails subcommands
- Added '/guardrail <instruction>' slash command for quick guardrail addition during sessions
- Added '/guardrails' slash command to open the guardrails management view
- Created GuardrailsView component in src/components/views/GuardrailsView.tsx for interactive guardrail management
- Added 'guardrails' to ActiveView type
- Updated ViewRouter to handle guardrails view
- Updated useSlashCommands hook to handle guardrail and guardrails commands
- Updated HelpView and help.ts to include guardrails documentation

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Implement adaptive retry with failure context injection
Date: 2026-01-20

Changes made:
- Created src/lib/failure-analyzer.ts with FailureAnalysis interface and analyzeFailure() function that categorizes failures and generates recovery suggestions
- Implemented failure pattern detection for: build_failure, test_failure, lint_error, permission_error, timeout, stuck, network_error, syntax_error, dependency_error, unknown
- Created generateRetryContext() function that formats context injection for the prompt with attempt number, failure category, root cause, and suggested approach
- Updated runAgentInternal() in src/stores/agentStore.ts to accept optional additionalContext parameter that gets appended to the prompt
- Modified retry loop in agentStore.start() to call analyzeFailure() on failure, generate retry context, and pass it to subsequent runAgentInternal() calls
- Added IterationLogRetryContext interface to src/types/session.types.ts with fields: attemptNumber, failureCategory, rootCause, contextInjected
- Added retryContexts field to IterationLogAgent interface to track retry context history
- Updated AgentCompleteEvent, AgentErrorEvent, and AgentRetryEvent in src/lib/events.ts to include retry context information
- Updated completeIterationLog() in src/lib/iteration-logs.ts to accept and store retryContexts
- Updated orchestrator to capture retry contexts from agent events and pass them to iteration logs
- Added logRetryContextsToProgress() in orchestrator to log retry analysis to progress.txt
- Added retryWithContext config option (boolean, default true) to RalphConfig to enable/disable adaptive retry
- Updated CONFIG_DEFAULTS in constants.ts, ConfigService.ts, and loader.ts to include retryWithContext

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Implement verification phase after each iteration
Date: 2026-01-20

Changes made:
- Created VerificationConfig interface in src/types/config.types.ts with fields: enabled, buildCommand, testCommand, lintCommand, customChecks, failOnWarning
- Created CheckResult and VerificationResult interfaces for verification results
- Added 'verification' section to RalphConfig type
- Created src/lib/verification.ts with runVerification(), runCheck(), formatVerificationResult(), and generateVerificationRetryContext() functions
- Updated orchestrator handleAgentComplete() to run verification after agent completes (before marking iteration as done)
- If verification fails, iteration status is set to 'verification_failed' and triggers retry
- Added IterationLogVerification interface to src/types/session.types.ts
- Added 'verification_failed' to IterationLogStatus type
- Updated completeIterationLog() in src/lib/iteration-logs.ts to accept verification results
- Added verification results logging to progress.txt via logVerificationResultToProgress()
- Added --skip-verification CLI flag to parser.ts and passed through to RunApp
- Added skipVerification parameter to setupIterationCallbacks() and orchestrator.initialize()
- Updated IterationProgress component to show verification status (isVerifying spinner and failed checks)
- Added isVerifying and lastVerificationResult fields to appStore state
- Added DEFAULT_VERIFICATION to src/lib/defaults.ts
- Updated CONFIG_DEFAULTS in constants.ts, ConfigService.ts, and loader.ts to include verification
- Updated help.ts to document --skip-verification flag

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Implement task decomposition request handling
Date: 2026-01-20

Changes made:
- Added DECOMPOSITION_MARKER constant ('<request>DECOMPOSE_TASK</request>') and DECOMPOSITION_OUTPUT_START/END markers to src/lib/prompt.ts
- Created DecompositionRequest and DecompositionSubtask interfaces in src/types/prd.types.ts
- Updated buildPrompt() to include decomposition instructions with example JSON format
- Created src/lib/decomposition.ts with parseDecompositionRequest() and applyDecomposition() functions
- Added formatDecompositionForProgress() for logging decomposition events
- Added maxDecompositionsPerTask config option (default: 2) to RalphConfig, DEFAULTS, CONFIG_DEFAULTS, and applyDefaults()
- Updated orchestrator to detect decomposition marker in agent output and handle it:
  - Parse decomposition request from output
  - Apply decomposition to PRD (replace original task with subtasks)
  - Save updated PRD
  - Log decomposition to progress.txt
  - Restart current iteration without incrementing counter
  - Track decomposition count per task to prevent infinite loops
- Added restartCurrentIteration() method to iteration store
- Added IterationLogDecomposition interface and 'decomposed' status to session.types.ts
- Updated completeIterationLog() to accept decomposition data
- Added lastDecomposition state to appStore
- Updated IterationProgress component to display decomposition feedback

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed

=== Task Completed ===
Task: Implement failure pattern learning and analysis
Date: 2026-01-20

Changes made:
- Created FailurePattern, FailureHistoryEntry, and FailureHistory interfaces in src/types/session.types.ts
- Added FAILURE_HISTORY_FILE_PATH constant to src/lib/paths.ts pointing to .ralph/failure-history.json
- Created src/lib/failure-patterns.ts with functions: loadFailureHistory(), saveFailureHistory(), recordFailure(), analyzePatterns(), getSuggestedGuardrails(), generatePatternReport(), formatPatternReport(), clearFailureHistory(), getFailureHistoryStats()
- Implemented pattern detection using regex matching and string similarity for common failure types
- Added 'ralph analyze' CLI command with patterns, export, and clear subcommands
- Created src/cli/commands/analyze.ts with printAnalyze(), handleAnalyzeExport(), handleAnalyzeClear()
- Added AnalyzeSubcommand type to src/types/cli.types.ts
- Updated parser.ts to handle analyze subcommands
- Added '/analyze' slash command to open the analyze view in the terminal UI
- Created AnalyzeView component in src/components/views/AnalyzeView.tsx for interactive pattern viewing and guardrail suggestions
- Added 'analyze' to ActiveView type and SlashCommand type
- Updated ViewRouter to handle analyze view
- Updated useSlashCommands hook to handle analyze command
- Updated HelpView and help.ts to include analyze documentation
- Integrated automatic failure recording in orchestrator.onIterationComplete() when learningEnabled is true
- Added learningEnabled config option (boolean, default true) to RalphConfig
- Updated CONFIG_DEFAULTS in constants.ts, ConfigService.ts, and loader.ts to include learningEnabled
- When a pattern reaches threshold (3 occurrences), automatically suggest adding a guardrail

Verification:
- bun check: passed
- bun run build: passed
- bun test: 171 tests passed
