# Progress

## Completed Tasks
- Wire up /tasks command and view routing: Added 'tasks' to ActiveView type, SlashCommand type, VALID_COMMANDS array, handled the command in useSlashCommands.ts to set active view, and added TasksView routing in ViewRouter.tsx. The /tasks command now opens the TasksView component.
- Add toggle done functionality to TasksView: Implemented 'd' key handler in TasksView that calls toggleTaskDone from prd.ts, saves the updated PRD, refreshes the local state, and displays a success message. Users can now mark tasks as done or undone directly from the TasksView using the 'd' key.
- Add delete task functionality with confirmation: Added a ViewMode type with 'list' and 'confirm-delete' modes to TasksView. Users can press 'x' to enter delete confirmation mode, which shows a red-bordered prompt with the task title and options to confirm (Enter) or cancel (Escape). After deletion, the selected index is adjusted to stay within bounds. The help text was updated to show the new 'x Delete' keyboard shortcut.
- Gracefully handle non-git repositories: Added isGitRepository() utility function in src/lib/paths.ts to check for .git directory existence. Updated appStore.ts to track isInGitRepository state during project validation (non-blocking). Modified buildPrompt() in src/lib/prompt.ts to conditionally include commit instructions based on git availability. Updated dry-run validation in useDryRun.ts to warn when not in a git repository. Added tests for the new isGitRepository() function.
- Create project registry types and resolution logic: Created src/lib/services/project-registry/types.ts with ProjectIdType ('git' | 'path' | 'custom'), ProjectIdentifier, ProjectMetadata, and ProjectRegistry interfaces. Created src/lib/services/project-registry/resolution.ts with pure functions: normalizeGitRemote (strips protocols and .git suffix, converts SSH format), hashPath (creates 12-char SHA-256 hash), sanitizeFolderName (replaces invalid chars with dashes), buildFolderName (creates prefixed folder name), and helper functions createProjectIdentifier, createGitProjectIdentifier, createPathProjectIdentifier. Created src/lib/services/project-registry/git.ts with getGitRemoteUrl function that runs 'git remote get-url origin'. Added comprehensive unit tests covering edge cases for SSH vs HTTPS URLs and special characters.
- Implement ProjectRegistryService: Created src/lib/services/project-registry/implementation.ts with createProjectRegistryService() factory function that manages the global project registry at ~/.ralph/registry.json and project data folders at ~/.ralph/projects/<folder-name>/. Implemented loadRegistry() and saveRegistry() for reading/writing the registry JSON. Implemented ensureProjectsDir() to create the projects directory. Implemented resolveCurrentProject() that checks pathCache first, then tries git remote detection, then path hash, returning ProjectIdentifier or null. Implemented registerProject() that determines identifier, creates project folder, updates registry and pathCache. Implemented getProjectDir() and getProjectFilePath() for path resolution. Added listProjects(), getProjectMetadata(), updateLastAccessed(), isProjectInitialized(), and removeProject() utility functions. Added ProjectRegistryService interface and RegisterProjectOptions type to types.ts. Created src/lib/services/project-registry/index.ts that exports all public types and the factory function. Added comprehensive unit tests in src/__tests__/lib/project-registry/implementation.test.ts using temp directories (34 tests covering all service methods).
- Integrate ProjectRegistryService into service container: Added 'projectRegistry: ProjectRegistryService' to ServiceContainer interface in src/lib/services/container.ts. Added getProjectRegistryService() accessor function following the existing service accessor pattern. Updated bootstrapServices() in src/lib/services/bootstrap.ts to create projectRegistry first via createProjectRegistryService(). Added createMockProjectRegistryService() with sensible test defaults (resolveCurrentProject returns a test path identifier, getProjectDir returns a temp path). Updated bootstrapTestServices() to include the mock projectRegistry. Exported ProjectRegistryService type, ProjectRegistryConfig type, and getProjectRegistryService from src/lib/services/index.ts. Refactored createProjectRegistryService() to accept optional ProjectRegistryConfig for dependency injection, enabling proper test isolation with temp directories. Updated implementation tests to use the config-based approach for proper test isolation.
- Convert path constants to registry-based functions: Converted src/lib/paths.ts to use the ProjectRegistryService for resolving project-specific file paths. Added new constants: REGISTRY_PATH, PROJECTS_DIR, LOCAL_RALPH_DIR (renamed from RALPH_DIR). Created new registry-based functions: getSessionFilePath(), getPrdJsonPath(), getProgressFilePath(), getInstructionsFilePath(), getProjectConfigPath(), getGuardrailsFilePath(), getFailureHistoryFilePath(), getSessionMemoryFilePath(), getLogsDir(), and getArchiveDir(). These functions call getProjectRegistryService().getProjectFilePath() to resolve paths in ~/.ralph/projects/<project-folder>/. Added ensureProjectDirExists() as the new project directory creation function using the registry. Kept deprecated exports (RALPH_DIR, LOGS_DIR, SESSION_FILE_PATH, PRD_JSON_PATH, etc.) pointing to local .ralph paths for backward compatibility during migration. Kept deprecated ensureRalphDirExists() for local .ralph creation during migration. Updated ensureLogsDirExists() to use getLogsDir(). All existing code continues to work with the deprecated constants pointing to local paths until Task 8 updates imports to use the new functions.
- Update all services to use new path functions: Verified that all service files in src/lib/services/ were already using the new path functions correctly (session, prd, config, guardrails, session-memory). Also verified that utility files (progress.ts, archive.ts, iteration-logs.ts, logger.ts, failure-patterns.ts, memory.ts, daemon.ts) were already using the new path functions. Updated src/components/InitWizard.tsx to use getProgressFilePath(), getPrdJsonPath(), and ensureProjectDirExists() instead of the deprecated PROGRESS_FILE_PATH, RALPH_DIR, and ensureRalphDirExists() constants. Updated src/stores/appStore.ts to remove the LOCAL_RALPH_DIR import and updated the validation error message to be more generic ("No prd.json found for this project" instead of referencing a specific path). All 507 tests pass.
- Update init flow for global storage: Updated InitWizard.tsx to register the project in the global registry before saving files by calling getProjectRegistryService().registerProject(process.cwd(), {displayName: prd.project}). The ensureProjectDirExists() call now correctly creates the project folder in ~/.ralph/projects/<folder-name>/ because the project is registered first. Updated the success message to show the global storage paths by fetching them fresh after registration. Updated validateProject() in appStore.ts to use getProjectRegistryService().isProjectInitialized() instead of findPrdFile() for checking project initialization. The findPrdFile() in prd/implementation.ts was already using getPrdJsonPath() from the registry, so no changes were needed there. All 507 tests pass.
- Add migration command and auto-migration prompt: Created src/lib/services/project-registry/migration.ts with migrateLocalRalphDir() function that detects local .ralph directory, registers project in registry, copies all files to new global location, and returns MigrationResult with detailed information. Added hasLocalRalphDir(), needsProjectMigration(), and removeLocalRalphDir() helper functions. Added 'migrate' CLI command in src/cli/commands/migrate.ts that calls migrateLocalRalphDir() and reports results, with --remove flag support to delete local directory after migration. Created MigrationPromptView.tsx component with interactive Y/N prompts for migration and optional deletion of local .ralph directory. Added 'migration_prompt' to ActiveView type and integrated routing in ViewRouter.tsx. Updated appStore.ts to detect migration needs on startup via needsProjectMigration() check in loadInitialState(), setting activeView to 'migration_prompt' when local .ralph exists but project is not registered. Added handleMigrationComplete() and handleMigrationSkip() actions to appStore. Added '/migrate' slash command support in CommandInput.tsx and useSlashCommands.ts. Updated help text to include migrate command documentation. All 507 tests pass.
- Add project management commands: Created src/cli/commands/projects.ts with printProjects() for listing all registered projects in a formatted table (Name, Path, Type, Last Used), printCurrentProject() for showing details about the current directory's project, and handleProjectsPrune() for removing orphaned projects with invalid paths. Added ProjectsSubcommand type ('list' | 'current' | 'prune') to cli.types.ts and parser.ts for subcommand handling. Created src/components/views/ProjectsView.tsx with interactive keyboard navigation (j/k or arrows), detail view (Enter), remove project (x), and prune orphaned projects (p) with confirmation. Added 'projects' to Command type, ActiveView type, SlashCommand type, and VALID_COMMANDS array. Integrated into ViewRouter.tsx and useSlashCommands.ts. Updated help.ts with projects command documentation including subcommands. All CLI commands support --json flag for scripting. All 507 tests pass.
