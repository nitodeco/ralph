---
import SidebarNav from "./SidebarNav.astro";

interface Props {
  currentPath?: string;
}

const { currentPath = "" } = Astro.props;

const NAV_ITEMS = [
  { label: "Docs", href: "/docs" },
  { label: "Changelog", href: "/changelog/" },
  { label: "GitHub", href: "https://github.com/nitodeco/ralph", isExternal: true },
];
---

<div
  id="mobile-nav"
  class="fixed inset-0 z-50 hidden md:hidden"
  role="dialog"
  aria-modal="true"
  aria-label="Navigation menu"
>
  <div
    id="mobile-nav-backdrop"
    class="fixed inset-0 bg-bg/80 backdrop-blur-sm transition-opacity duration-300 opacity-0"
    aria-hidden="true"
  ></div>

  <div
    id="mobile-nav-panel"
    class="fixed inset-y-0 left-0 w-full max-w-xs bg-bg border-r border-border shadow-lg transition-transform duration-300 -translate-x-full"
  >
    <div class="flex h-14 items-center justify-between border-b border-border px-4">
      <a href="/" class="font-semibold text-text">Ralph</a>
      <button
        type="button"
        id="mobile-nav-close"
        class="flex h-11 w-11 items-center justify-center rounded-md text-text-muted hover:bg-bg-elevated hover:text-text"
        aria-label="Close menu"
      >
        <svg
          class="h-5 w-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <div class="overflow-y-auto h-[calc(100vh-3.5rem)]">
      <nav class="border-b border-border px-4 py-4" aria-label="Main navigation">
        <ul class="space-y-1">
          {NAV_ITEMS.map((item) => (
            <li>
              <a
                href={item.href}
                class="block rounded-md px-3 py-2 text-sm font-medium text-text-muted hover:bg-bg-elevated hover:text-text transition-colors"
                {...(item.isExternal ? { target: "_blank", rel: "noopener noreferrer" } : {})}
              >
                {item.label}
                {item.isExternal && (
                  <>
                    <span class="ml-1" aria-hidden="true">â†—</span>
                    <span class="sr-only">(opens in new tab)</span>
                  </>
                )}
              </a>
            </li>
          ))}
        </ul>
      </nav>

      <div class="px-4 py-6">
        <SidebarNav currentPath={currentPath} />
      </div>
    </div>
  </div>
</div>

<script is:inline>
  let isInitialized = false;
  let openButtonHandler = null;
  let closeButtonHandler = null;
  let backdropHandler = null;
  let escapeHandler = null;
  let trapFocusHandler = null;
  let returnFocusElement = null;

  function initMobileNav() {
    const mobileNav = document.getElementById("mobile-nav");
    const mobileNavPanel = document.getElementById("mobile-nav-panel");
    const mobileNavBackdrop = document.getElementById("mobile-nav-backdrop");
    const closeButton = document.getElementById("mobile-nav-close");
    const toggleButton = document.querySelector("[data-mobile-menu-toggle]");
    if (!mobileNav || !mobileNavPanel || !mobileNavBackdrop) {
      return;
    }

    if (isInitialized) {
      if (openButtonHandler) document.removeEventListener("click", openButtonHandler);
      if (closeButtonHandler && closeButton) closeButton.removeEventListener("click", closeButtonHandler);
      if (backdropHandler) mobileNavBackdrop.removeEventListener("click", backdropHandler);
      if (escapeHandler) document.removeEventListener("keydown", escapeHandler);
    }

    const getFocusableElements = () => {
      const focusableSelectors = 'a[href], button:not([disabled]), input:not([disabled]), textarea:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])';

      return Array.from(mobileNavPanel?.querySelectorAll(focusableSelectors) ?? []);
    };

    trapFocusHandler = (event) => {
      if (event.key !== "Tab" || mobileNav?.classList.contains("hidden")) {
        return;
      }

      const focusableElements = getFocusableElements();
      const firstElement = focusableElements.at(0);
      const lastElement = focusableElements.at(-1);

      if (!firstElement || !lastElement) {
        return;
      }

      if (event.shiftKey && document.activeElement === firstElement) {
        event.preventDefault();
        lastElement.focus();
      } else if (!event.shiftKey && document.activeElement === lastElement) {
        event.preventDefault();
        firstElement.focus();
      }
    };

    const openMenu = () => {
      if (!mobileNav.classList.contains("hidden")) {
        return;
      }

      returnFocusElement = document.activeElement;
      mobileNav.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      if (toggleButton instanceof HTMLElement) {
        toggleButton.setAttribute("aria-expanded", "true");
      }
      requestAnimationFrame(() => {
        mobileNavPanel.classList.remove("-translate-x-full");
        mobileNavBackdrop.classList.remove("opacity-0");
        mobileNavBackdrop.classList.add("opacity-100");
      });
      closeButton?.focus();
      if (trapFocusHandler) {
        document.addEventListener("keydown", trapFocusHandler);
      }
    };

    const closeMenu = () => {
      mobileNavPanel.classList.add("-translate-x-full");
      mobileNavBackdrop.classList.remove("opacity-100");
      mobileNavBackdrop.classList.add("opacity-0");
      document.body.style.overflow = "";
      if (toggleButton instanceof HTMLElement) {
        toggleButton.setAttribute("aria-expanded", "false");
      }
      if (trapFocusHandler) {
        document.removeEventListener("keydown", trapFocusHandler);
      }
      setTimeout(() => {
        mobileNav.classList.add("hidden");
      }, 300);
      if (returnFocusElement instanceof HTMLElement) {
        returnFocusElement.focus();
      }
    };

    openButtonHandler = (event) => {
      const target = event.target;
      if (!(target instanceof Element)) {
        return;
      }

      const toggleButton = target.closest("[data-mobile-menu-toggle]");
      if (!toggleButton) {
        return;
      }

      event.preventDefault();
      openMenu();
    };
    closeButtonHandler = closeMenu;
    backdropHandler = closeMenu;
    escapeHandler = (event) => {
      if (event.key === "Escape" && !mobileNav.classList.contains("hidden")) {
        closeMenu();
      }
    };

    document.addEventListener("click", openButtonHandler);
    if (closeButton) {
      closeButton.addEventListener("click", closeButtonHandler);
    }
    mobileNavBackdrop.addEventListener("click", backdropHandler);
    document.addEventListener("keydown", escapeHandler);

    isInitialized = true;
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMobileNav);
  } else {
    initMobileNav();
  }

  document.addEventListener("astro:page-load", initMobileNav);
</script>
