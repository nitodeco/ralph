---
interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;
---

<div class={className}>
  <button
    type="button"
    class="search-trigger flex h-9 w-full items-center gap-2 rounded-md border border-border bg-bg-elevated px-3 text-sm text-text-muted hover:bg-bg-subtle hover:text-text hover:border-brand/30 transition-all duration-150"
    aria-label="Open search"
    aria-haspopup="dialog"
  >
    <svg
      class="h-4 w-4 shrink-0"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
      />
    </svg>
    <span class="hidden flex-1 text-left sm:inline">Search docs...</span>
    <kbd class="hidden rounded border border-border bg-bg px-1.5 py-0.5 text-xs font-medium text-text-subtle sm:inline">
      <span class="search-kbd-mac hidden">⌘K</span>
      <span class="search-kbd-other hidden">Ctrl K</span>
    </kbd>
  </button>
</div>

<div
  id="search-modal"
  class="search-modal fixed inset-0 z-50 hidden items-start justify-center pt-[10vh]"
  role="dialog"
  aria-modal="true"
  aria-labelledby="search-modal-title"
>
  <div class="search-backdrop fixed inset-0 bg-black/70 backdrop-blur-sm"></div>

  <div class="search-container relative mx-4 w-full max-w-2xl rounded-xl border border-border bg-bg-elevated shadow-2xl">
    <div class="search-container-glow"></div>
    <h2 id="search-modal-title" class="sr-only">Search documentation</h2>

    <div class="flex items-center gap-3 border-b border-border px-4 py-3">
      <svg
        class="h-5 w-5 shrink-0 text-brand"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        />
      </svg>
      <input
        id="search-input"
        type="text"
        class="flex-1 bg-transparent text-text placeholder:text-text-subtle focus:outline-none"
        placeholder="Search documentation..."
        autocomplete="off"
        aria-describedby="search-results-status"
      />
      <button
        type="button"
        class="search-close flex h-6 items-center gap-1 rounded border border-border bg-bg px-1.5 text-xs font-medium text-text-subtle hover:text-text hover:border-text-subtle transition-colors"
        aria-label="Close search"
      >
        <span>esc</span>
      </button>
    </div>

    <div
      id="search-results-status"
      class="sr-only"
      aria-live="polite"
      aria-atomic="true"
    ></div>

    <div id="search-results" class="max-h-[60vh] overflow-y-auto p-2">
      <div class="search-empty px-4 py-8 text-center text-text-muted">
        <p>Start typing to search the docs...</p>
      </div>
    </div>

    <div class="flex items-center justify-between border-t border-border px-4 py-2.5 text-xs text-text-subtle">
      <div class="flex items-center gap-4">
        <span class="flex items-center gap-1.5">
          <kbd class="kbd-hint">↑</kbd>
          <kbd class="kbd-hint">↓</kbd>
          <span>navigate</span>
        </span>
        <span class="flex items-center gap-1.5">
          <kbd class="kbd-hint">↵</kbd>
          <span>select</span>
        </span>
        <span class="flex items-center gap-1.5">
          <kbd class="kbd-hint">/</kbd>
          <span>search</span>
        </span>
      </div>
      <span class="text-text-subtle/70">Powered by Pagefind</span>
    </div>
  </div>
</div>

<script>
  interface PagefindResult {
    id: string;
    data: () => Promise<PagefindResultData>;
  }

  interface PagefindResultData {
    url: string;
    meta: {
      title?: string;
    };
    excerpt: string;
    sub_results?: Array<{
      url: string;
      title: string;
      excerpt: string;
    }>;
  }

  interface PagefindInstance {
    search: (query: string) => Promise<{ results: PagefindResult[] }>;
    debouncedSearch: (query: string, options?: { debounceTimeoutMs?: number }) => Promise<{ results: PagefindResult[] } | null>;
  }

  let pagefind: PagefindInstance | null = null;
  let selectedIndex = -1;

  async function initPagefind(): Promise<PagefindInstance | null> {
    if (pagefind) {
      return pagefind;
    }

    try {
      const pagefindPath = `${window.location.origin}/ralph/pagefind/pagefind.js`;
      pagefind = await import(/* @vite-ignore */ pagefindPath);

      return pagefind;
    } catch {
      console.warn("Pagefind not available. Search will not work in dev mode.");

      return null;
    }
  }

  function openModal(): void {
    const modal = document.getElementById("search-modal");
    const input = document.getElementById("search-input") as HTMLInputElement;
    const container = modal?.querySelector(".search-container");

    if (modal && input) {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      container?.classList.add("animate-scale-in");
      input.focus();
      document.body.style.overflow = "hidden";
    }
  }

  function closeModal(): void {
    const modal = document.getElementById("search-modal");
    const input = document.getElementById("search-input") as HTMLInputElement;

    if (modal && input) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      input.value = "";
      document.body.style.overflow = "";
      selectedIndex = -1;
      resetResults();
    }
  }

  function resetResults(): void {
    const resultsContainer = document.getElementById("search-results");
    const statusElement = document.getElementById("search-results-status");

    if (resultsContainer) {
      resultsContainer.innerHTML = `
        <div class="search-empty px-4 py-8 text-center text-text-muted">
          <p>Start typing to search the docs...</p>
        </div>
      `;
    }

    if (statusElement) {
      statusElement.textContent = "";
    }
  }

  function renderResults(results: PagefindResultData[]): void {
    const resultsContainer = document.getElementById("search-results");
    const statusElement = document.getElementById("search-results-status");

    if (!resultsContainer) {
      return;
    }

    if (results.length === 0) {
      resultsContainer.innerHTML = `
        <div class="search-empty px-4 py-8 text-center text-text-muted">
          <p>No results found.</p>
        </div>
      `;

      if (statusElement) {
        statusElement.textContent = "No results found";
      }

      return;
    }

    const html = results
      .map(
        (result, index) => `
        <a
          href="${result.url}"
          class="search-result block rounded-lg px-4 py-3 transition-all duration-150 ${index === selectedIndex ? "bg-brand/10 border-l-2 border-brand" : "hover:bg-bg-subtle"}"
          data-index="${index}"
        >
          <div class="font-medium text-text">${result.meta.title ?? "Untitled"}</div>
          <div class="mt-1 text-sm text-text-muted line-clamp-2">${result.excerpt}</div>
        </a>
      `
      )
      .join("");

    resultsContainer.innerHTML = html;

    if (statusElement) {
      statusElement.textContent = `${results.length} result${results.length === 1 ? "" : "s"} found`;
    }
  }

  function updateSelection(newIndex: number): void {
    const results = document.querySelectorAll(".search-result");

    if (results.length === 0) {
      return;
    }

    selectedIndex = Math.max(0, Math.min(newIndex, results.length - 1));

    for (const [i, result] of results.entries()) {
      if (i === selectedIndex) {
        result.classList.add("bg-brand/10", "border-l-2", "border-brand");
        result.classList.remove("hover:bg-bg-subtle");
        result.scrollIntoView({ block: "nearest" });
      } else {
        result.classList.remove("bg-brand/10", "border-l-2", "border-brand");
        result.classList.add("hover:bg-bg-subtle");
      }
    }
  }

  function selectResult(): void {
    const results = document.querySelectorAll(".search-result");

    if (selectedIndex >= 0 && selectedIndex < results.length) {
      const result = results[selectedIndex] as HTMLAnchorElement;
      window.location.href = result.href;
    }
  }

  let debounceTimeout: ReturnType<typeof setTimeout> | null = null;

  async function handleSearch(query: string): Promise<void> {
    if (debounceTimeout) {
      clearTimeout(debounceTimeout);
    }

    if (!query.trim()) {
      resetResults();

      return;
    }

    const pf = await initPagefind();

    if (!pf) {
      return;
    }

    debounceTimeout = setTimeout(async () => {
      const searchResults = await pf.search(query);
      const resultsData: PagefindResultData[] = [];

      for (const result of searchResults.results.slice(0, 10)) {
        const resultData = await result.data();
        resultsData.push(resultData);
      }

      selectedIndex = -1;
      renderResults(resultsData);
    }, 150);
  }

  function initSearch(): void {
    const triggers = document.querySelectorAll(".search-trigger");
    const closeButtons = document.querySelectorAll(".search-close");
    const backdrop = document.querySelector(".search-backdrop");
    const input = document.getElementById("search-input") as HTMLInputElement;

    for (const trigger of triggers) {
      trigger.addEventListener("click", openModal);
    }

    for (const button of closeButtons) {
      button.addEventListener("click", closeModal);
    }

    backdrop?.addEventListener("click", closeModal);

    document.addEventListener("keydown", (event: KeyboardEvent) => {
      const modal = document.getElementById("search-modal");
      const isModalOpen = modal && !modal.classList.contains("hidden");

      const isModKey = event.metaKey || event.ctrlKey;
      if (isModKey && event.key === "k") {
        event.preventDefault();
        if (isModalOpen) {
          closeModal();
        } else {
          openModal();
        }

        return;
      }

      if (event.key === "/" && !isModalOpen) {
        const activeElement = document.activeElement;
        const isInputFocused =
          activeElement instanceof HTMLInputElement ||
          activeElement instanceof HTMLTextAreaElement ||
          (activeElement as HTMLElement)?.isContentEditable;

        if (!isInputFocused) {
          event.preventDefault();
          openModal();
        }
      }

      if (event.key === "Escape" && isModalOpen) {
        event.preventDefault();
        closeModal();
      }

      if (isModalOpen) {
        if (event.key === "ArrowDown") {
          event.preventDefault();
          updateSelection(selectedIndex + 1);
        } else if (event.key === "ArrowUp") {
          event.preventDefault();
          updateSelection(selectedIndex - 1);
        } else if (event.key === "Enter") {
          event.preventDefault();
          selectResult();
        }
      }
    });

    input?.addEventListener("input", (event: Event) => {
      const target = event.target as HTMLInputElement;
      handleSearch(target.value);
    });
  }

  function updateKeyboardHint(): void {
    const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
    const macHints = document.querySelectorAll(".search-kbd-mac");
    const otherHints = document.querySelectorAll(".search-kbd-other");

    for (const hint of macHints) {
      hint.classList.toggle("hidden", !isMac);
    }

    for (const hint of otherHints) {
      hint.classList.toggle("hidden", isMac);
    }
  }

  document.addEventListener("astro:page-load", () => {
    initSearch();
    updateKeyboardHint();
  });
  initSearch();
  updateKeyboardHint();
</script>

<style>
  .search-container {
    position: relative;
    overflow: hidden;
  }

  .search-container-glow {
    position: absolute;
    top: -1px;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(
      90deg,
      transparent 0%,
      var(--color-brand) 50%,
      transparent 100%
    );
    opacity: 0.5;
  }

  .search-modal {
    animation: fadeIn 0.15s ease-out;
  }

  .animate-scale-in {
    animation: scaleIn 0.2s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.96) translateY(-8px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .kbd-hint {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.25rem;
    height: 1.25rem;
    padding: 0 0.25rem;
    font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, monospace;
    font-size: 0.65rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    color: var(--color-text-subtle);
  }

  .search-result {
    position: relative;
  }

  .search-result.bg-brand\/10 {
    background: rgba(34, 211, 238, 0.08);
  }

  @media (prefers-reduced-motion: reduce) {
    .search-modal,
    .animate-scale-in {
      animation: none;
    }
  }
</style>
