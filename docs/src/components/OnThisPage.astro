---
interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;

const filteredHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{filteredHeadings.length > 0 && (
  <nav class="on-this-page" aria-label="On this page">
    <h4 class="text-xs font-semibold uppercase tracking-wider text-text-subtle mb-3">
      On this page
    </h4>
    <ul class="space-y-2 text-sm">
      {filteredHeadings.map((heading) => (
        <li class:list={[heading.depth === 3 && "ml-3"]}>
          <a
            href={`#${heading.slug}`}
            class="block text-text-muted hover:text-brand transition-colors py-0.5 toc-link"
            data-heading-slug={heading.slug}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<script>
  const updateActiveLink = () => {
    const headings = document.querySelectorAll("h2[id], h3[id]");
    const tocLinks = document.querySelectorAll(".toc-link");

    if (headings.length === 0 || tocLinks.length === 0) return;

    const scrollY = window.scrollY;
    const windowHeight = window.innerHeight;
    const docHeight = document.documentElement.scrollHeight;

    const isNearBottom = scrollY + windowHeight >= docHeight - 100;

    let activeIndex = 0;

    if (isNearBottom) {
      activeIndex = headings.length - 1;
    } else {
      const offset = 100;

      for (let i = 0; i < headings.length; i++) {
        const heading = headings[i] as HTMLElement;
        const headingTop = heading.offsetTop;

        if (scrollY >= headingTop - offset) {
          activeIndex = i;
        } else {
          break;
        }
      }
    }

    tocLinks.forEach((link, i) => {
      if (i === activeIndex) {
        link.classList.remove("text-text-muted");
        link.classList.add("text-brand", "font-medium");
      } else {
        link.classList.remove("text-brand", "font-medium");
        link.classList.add("text-text-muted");
      }
    });
  };

  updateActiveLink();

  let ticking = false;
  window.addEventListener("scroll", () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateActiveLink();
        ticking = false;
      });
      ticking = true;
    }
  });
</script>

<style>
  .on-this-page {
    position: sticky;
    top: 6rem;
  }
</style>
