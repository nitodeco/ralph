---
import { getCollection } from "astro:content";

interface Props {
  currentPath?: string;
}

const { currentPath = "" } = Astro.props;

interface NavItem {
  title: string;
  href: string;
  order: number;
  label?: string;
}

interface NavSection {
  section: string;
  items: NavItem[];
}

const docs = await getCollection("docs");

const buildNavigation = (entries: typeof docs): NavSection[] => {
  const sectionItemsBySection: Record<string, NavItem[]> = {};

  for (const entry of entries) {
    if (entry.id === "index") {
      continue;
    }

    const pathParts = entry.id.split("/");
    const section = pathParts.at(0)!;
    const href = `/ralph/docs/${entry.id}/`;

    const item: NavItem = {
      title: entry.data.title,
      href,
      order: entry.data.sidebar.order,
      label: entry.data.sidebar.label,
    };

    if (!sectionItemsBySection[section]) {
      sectionItemsBySection[section] = [];
    }
    sectionItemsBySection[section].push(item);
  }

  const SECTION_ORDER = [
    "Getting Started",
    "getting-started",
    "core-concepts",
    "cli-reference",
    "configuration",
    "github-integration",
    "troubleshooting",
    "contributing",
    "faq",
  ];

  return Object.entries(sectionItemsBySection)
    .map(([section, items]) => ({
      section: formatSectionName(section),
      items: items.sort((a, b) => a.order - b.order),
      rawSection: section,
    }))
    .sort((a, b) => {
      const indexA = SECTION_ORDER.indexOf(a.rawSection);
      const indexB = SECTION_ORDER.indexOf(b.rawSection);
      const orderA = indexA === -1 ? 999 : indexA;
      const orderB = indexB === -1 ? 999 : indexB;

      return orderA - orderB;
    })
    .map(({ section, items }) => ({ section, items }));
};

const formatSectionName = (name: string): string => {
  if (name === "Getting Started") {
    return name;
  }

  return name
    .split("-")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
};

const isActive = (href: string) => {
  const normalizedCurrent = currentPath.replace(/\/$/, "");
  const normalizedHref = href.replace(/\/$/, "");

  return normalizedCurrent === normalizedHref;
};

const navigation = buildNavigation(docs);
---

<nav class="sidebar-nav space-y-6" aria-label="Docs navigation">
  {navigation.map((section) => (
    <div class="sidebar-section">
      <h3 class="section-header mb-2 px-3 text-xs font-semibold uppercase tracking-wider text-text-subtle flex items-center gap-2">
        <span class="section-accent"></span>
        {section.section}
      </h3>
      <ul class="space-y-0.5" role="list">
        {section.items.map((item) => (
          <li>
            <a
              href={item.href}
              class:list={[
                "sidebar-link block rounded-md px-3 py-2 text-sm transition-all duration-150",
                isActive(item.href)
                  ? "sidebar-link-active bg-gradient-to-r from-brand/15 to-brand/5 text-brand font-medium"
                  : "text-text-muted hover:text-text hover:bg-bg-elevated hover:translate-x-0.5",
              ]}
              aria-current={isActive(item.href) ? "page" : undefined}
            >
              {item.label ?? item.title}
            </a>
          </li>
        ))}
      </ul>
    </div>
  ))}
</nav>

<style>
  .section-accent {
    width: 2px;
    height: 12px;
    background: var(--color-brand);
    border-radius: 1px;
    opacity: 0.6;
  }

  .sidebar-link-active {
    position: relative;
  }

  .sidebar-link-active::before {
    content: "";
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 16px;
    background: var(--color-brand);
    border-radius: 1px;
    box-shadow: var(--glow-brand-subtle);
  }

  .sidebar-link:not(.sidebar-link-active) {
    position: relative;
  }

  .sidebar-link:not(.sidebar-link-active)::before {
    content: "";
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 0;
    background: var(--color-brand);
    border-radius: 1px;
    opacity: 0.4;
    transition: height 0.15s ease;
  }

  .sidebar-link:not(.sidebar-link-active):hover::before {
    height: 12px;
  }
</style>
